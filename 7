from fastapi import FastAPI, Depends, HTTPException
from sqlalchemy.orm import Session
import crud
import models
from database import engine, SessionLocal
from csv_loader import load_students_from_csv

# Создаём таблицы
models.Base.metadata.create_all(bind=engine)

app = FastAPI(title="Students DB API")


# Dependency
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()


@app.on_event("startup")
def on_startup():
    load_students_from_csv()  # автоматически загружаем при старте


@app.get("/students/faculty/{faculty}")
def students_by_faculty(faculty: str, db: Session = Depends(get_db)):
    students = crud.get_students_by_faculty(db, faculty)
    if not students:
        raise HTTPException(status_code=404, detail="Факультет не найден")
    return students


@app.get("/courses/unique")
def unique_courses(db: Session = Depends(get_db)):
    courses = crud.get_unique_courses(db)
    return [c[0] for c in courses]


@app.get("/faculty/{faculty}/avg-grade")
def avg_grade_by_faculty(faculty: str, db: Session = Depends(get_db)):
    avg = crud.get_avg_grade_by_faculty(db, faculty)
    if avg is None:
        raise HTTPException(status_code=404, detail="Факультет не найден")
    return {"faculty": faculty, "avg_grade": avg}


@app.get("/course/{course}/low-grades")
def low_grade_students(course: str, threshold: float = 30.0, db: Session = Depends(get_db)):
    students = crud.get_low_grade_students_by_course(db, course, threshold)
    return {"course": course, "students_below_threshold": students}
